# Reusable Patterns

- Use `Bun.file(path).exists()` for existence checks (async)
- Use `Bun.$` shell for filesystem operations in tests
- Walk up directory tree using `dirname()` until `parent === dir` (root)
- Use `crypto.getRandomValues(new Uint8Array(n))` for crypto-secure random bytes
- Use type guards with `unknown` for runtime validation (return `x is Type` pattern)
- Use `as const` for compile-time tuple inference on required field arrays
- CLI tests need absolute paths when running from different cwd - use `join(import.meta.dir, '..', '..')` to get project root
- Parse JSON input with try/catch, check for SyntaxError to distinguish parse errors from validation errors
- Use nullish coalescing (`??`) for applying defaults to optional fields
- ANSI escape codes: `\x1b[2m` for dim, `\x1b[32m` for green, `\x1b[0m` to reset

---

## 2026-01-07 - d5e6f7

- Implemented `chief done` command in `src/commands/done.ts`
- Files changed: `src/commands/done.ts`, `src/commands/done.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Simple mutation commands: find by ID -> mutate -> write
  - Idempotent operations (done on already-done) should succeed silently

---

## 2026-01-07 - g1h2i3

- Implemented `chief list` command in `src/commands/list.ts`
- Files changed: `src/commands/list.ts`, `src/commands/list.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Group children by parent using `Map<string, Issue[]>` for efficient lookup
  - Read-only commands follow simpler pattern: read store -> format output -> print

---

## 2026-01-07 - c9d0e1

- Implemented `chief new` command with JSON argument in `src/commands/new.ts`
- Files changed: `src/commands/new.ts`, `src/commands/new.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Separate input parsing/validation from applying defaults for cleaner code
  - Commands that modify state should: parse input -> read store -> generate ID -> apply defaults -> validate -> write

---

## 2026-01-07 - b2c3d4

- Implemented `chief init` command in `src/commands/init.ts`
- Files changed: `src/commands/init.ts`, `src/commands/init.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Integration tests running CLI from different cwd need absolute paths to the CLI entry point
  - Use `mkdir` with `recursive: true` to create parent directories idempotently
  - Commands should be organized in `src/commands/` directory and imported into index.ts

---

## 2026-01-07 - e4f5a6

- Implemented validation logic in `src/validate.ts`
- Files changed: `src/validate.ts`, `src/validate.test.ts`, `prd.json`
- **Learnings:**
  - Validation functions should throw descriptive errors, not return booleans
  - Type guard pattern (`function f(x: unknown): x is Type`) provides runtime validation with type narrowing
  - Separate field validation from referential integrity checks for cleaner testing

---

## 2026-01-07 - d1e2f3

- Implemented ID generation utility in `src/id.ts`
- Files changed: `src/id.ts`, `src/id.test.ts`
- **Learnings:**
  - `crypto.getRandomValues()` is globally available in Bun (no import needed)
  - Use Set for O(1) collision checking when generating unique IDs

---

## 2026-01-07 - a7b8c9

- Implemented core JSON read/write utilities in `src/store.ts`
- Files changed: `src/store.ts`, `src/store.test.ts`, `AGENTS.md`, `.gitignore`
- **Learnings:**
  - `Bun.file().size` returns 0 for non-existent files (doesn't throw), use `.exists()` instead
  - `Bun.file().exists()` is async, requires refactoring sync functions
  - `Bun.$` shell template provides clean syntax for filesystem ops in tests

---
