- Issues are stored 1 per line for compact storage and clean git diffs: `{"issues": [\n{...issue1...},\n{...issue2...}\n]}`
- When updating `done` field via update command, also update `doneAt` to maintain consistency with done/reopen commands
- Use `resolveParentIdOrExit(store, parentIdPrefix)` from store.ts to resolve parent ID prefix to full ID (handles null passthrough)

# Reusable Patterns

- Use `setupTestDir(name, options)` from test-helpers.ts for test setup/teardown - returns `{ testDir, issuesPath }` and handles beforeEach/afterEach
- Options: `{ init: true }` (default) runs `chief init`, `{ init: false }` creates empty dir, `{ createIssuesDir: true }` creates `.issues/issues.json` without CLI
- Use `parseJsonOrExit(json, parseFn)` from validate.ts for JSON input commands - handles SyntaxError and ValidationError uniformly
- Command registry pattern: define `{ usage, description, handler }` per command in single file, derive help text and routing from it
- Use `arg(args, index, usage)` helper that checks for undefined and exits with usage message - provides type narrowing
- Define valid fields as a simple array, use `filter` + `!includes` to detect unknown fields

- When verifying tasks, check progress.txt for prior completions - work may have been done as part of another task
- Use `findIssueOrExit(store, idPrefix, label?)` from store.ts when a command needs to find an issue by ID prefix and exit if not found (supports partial ID matching, optional label for error messages)
- Install scripts: use `set -euo pipefail`, detect OS/arch with `uname -s/-m`, prefer curl with wget fallback
- Use `Bun.file(path).exists()` for existence checks (async)
- Use `Bun.$` shell for filesystem operations in tests
- Walk up directory tree using `dirname()` until `parent === dir` (root)
- Use `crypto.getRandomValues(new Uint8Array(n))` for crypto-secure random bytes
- Use type guards with `unknown` for runtime validation (return `x is Type` pattern)
- Use `as const` for compile-time tuple inference on required field arrays
- CLI tests need absolute paths when running from different cwd - use `new URL('..', import.meta.url).pathname` to get resolved project root
- Parse JSON input with try/catch, check for SyntaxError to distinguish parse errors from validation errors
- Use nullish coalescing (`??`) for applying defaults to optional fields
- ANSI escape codes: `\x1b[2m` for dim, `\x1b[1m` for bold, `\x1b[0m` to reset
- Use `Bun.color('colorname', 'ansi')` for terminal colors - returns 256-color ANSI codes, null for non-colors
- Centralize terminal styling in a shared module when multiple files need same colors/styles
- Date formatting: `String(n).padStart(2, '0')` for zero-padded numbers
- For CLI help: use a `Record<string, CommandHelp>` object with usage, description, args, examples for each command
- Test stderr output with `Bun.spawn` + pipe stderr, then read with `new Response(proc.stderr).text()`
- Use `new Date().toISOString()` for ISO 8601 timestamps (includes timezone Z suffix)
- When adding optional fields to an existing type, update all places that create objects of that type (tests, defaults, validation)

- For idempotent state-change commands: check current state, return early with appropriate message, skip write
- For prefix matching: filter by `startsWith`, handle 0 matches (not found), 1 match (success), >1 matches (ambiguous error listing all matches)
- For CLI flags: use `args.includes('--flag')` to detect, export filter type from command module for type safety
- For `--key=value` flags: use `args.find(a => a.startsWith('--key='))?.slice('--key='.length)`
- When filtering hierarchical data with parent/child: compute child matches first, show parent if it matches OR if any child matches (provides context)
- When validating parent changes, check both directions: target parent cannot be a child AND issue cannot have children if becoming a child
- Use `ISSUE_FIELDS` from schema.ts as single source of truth for field definitions (types, defaults, validators)
- Use `getDefault(fieldName)` from schema.ts to get default values for optional fields
- Use `UPDATABLE_FIELD_NAMES` from schema.ts for the list of fields that can be changed via update
- Use `validateField(fieldName, value)` from schema.ts to validate individual fields
- To avoid circular deps: put ValidationError in separate errors.ts, re-export from validate.ts for backward compat
- Use template literals for path joining: `${dir}/${file}` instead of `join(dir, file)` - Bun works cross-platform with forward slashes
- Use `new URL('..', import.meta.url).pathname` for resolved relative paths - removes `..` from the path
- Use `Bun.write()` instead of `mkdir` + write - it creates parent directories automatically
- Implement `dirname()` locally: find last `/`, handle edge cases for root and no-slash paths

---

## 2026-01-08 - 953632

- Changed issues.json format from pretty-printed to 1 issue per line
- Each issue is serialized as compact JSON on its own line
- Files changed: `src/store.ts`, `src/store.test.ts`
- **Learnings:**
  - Format: `{"issues": [\n{...},\n{...}\n]}` - still valid JSON, but one issue per line
  - Git diffs now show only changed lines instead of entire reindented blocks
  - File size reduced from 832 lines to 49 lines for the project's issues

---

## 2026-01-08 - c6aa96

- Added `resolveParentIdOrExit` helper in store.ts for parent ID prefix resolution
- Updated `new.ts` and `update.ts` to resolve parent prefixes before storing
- Updated test error messages to match new consistent format ("not found" instead of "does not exist")
- Added tests for parent prefix matching in both new and update commands
- Files changed: `src/store.ts`, `src/commands/new.ts`, `src/commands/update.ts`, `src/commands/new.test.ts`, `src/commands/update.test.ts`
- **Learnings:**
  - Reuse `findIssueOrExit` directly with a label parameter instead of duplicating prefix matching logic
  - Resolve prefixes early (before validation) so validation operates on full IDs

---

## 2026-01-08 - 18dba8

- Fixed `chief update` to set doneAt timestamp when updating `done: true`
- Fixed `chief update` to clear doneAt when updating `done: false`
- Added test cases for both scenarios
- Files changed: `src/commands/update.ts`, `src/commands/update.test.ts`
- **Learnings:**
  - State changes affecting related fields should update all related fields together
  - Using ternary inline keeps the logic compact: `issue.doneAt = updates.done ? new Date().toISOString() : null`

---

## 2026-01-08 - 6110aa

- Added `.quiet()` to all `.nothrow()` calls in test files to suppress terminal output on passing tests
- Files changed: `src/help.test.ts`, `src/commands/done.test.ts`, `src/commands/reopen.test.ts`, `src/commands/remove.test.ts`, `src/commands/note.test.ts`, `src/commands/new.test.ts`, `src/commands/show.test.ts`, `src/commands/list.test.ts`, `src/commands/update.test.ts`

---

## 2026-01-08 - c9f3a4

- Exported `Command` interface from commands.ts
- Files changed: `src/commands.ts`
- **Learnings:**
  - Task was largely completed as part of c39dae (command registry extraction)

---

## 2026-01-08 - a7d1e2

- Removed all `node:path` and `node:fs/promises` imports
- Replaced `join()` with template literals throughout codebase
- Replaced `dirname()` with local implementation in store.ts
- Replaced `mkdir()` with `Bun.write()` which creates parent dirs automatically
- Used `new URL('..', import.meta.url).pathname` for path resolution in test-helpers.ts
- Removed unused `ISSUES_DIR_IN_CWD` export
- Files changed: `src/store.ts`, `src/commands/init.ts`, `src/test-helpers.ts`, `src/commands/init.test.ts`, `src/store.test.ts`, `src/commands/list.test.ts`
- **Learnings:**
  - Bun lacks built-in path resolution; URL API can normalize paths with `..`
  - `Bun.write()` creates parent directories - no need for separate mkdir
  - Template literal paths work cross-platform in Bun (always uses forward slashes internally)

---

## 2026-01-08 - b8e2f3

- Verified task was already completed as part of aa1b2c (ID prefix matching)
- All acceptance criteria met: all commands use `findIssueOrExit`, update.ts already uses it, error messages consistent
- Files changed: `prd.json` (mark done)
- **Learnings:**
  - Tasks can be implicitly completed as part of other work - verify before implementing
  - The aa1b2c progress entry documented: "The `update.ts` command was not using `findIssueOrExit` - refactored to use it for consistency"

---

## 2026-01-08 - f6c0d1

- Created `src/schema.ts` as single source of truth for Issue field definitions
- Created `src/errors.ts` for ValidationError to avoid circular dependencies
- Refactored new.ts to use `getDefault()` from schema for applying defaults
- Refactored update.ts to use `UPDATABLE_FIELD_NAMES` from schema for field validation
- Refactored validate.ts to use `validateField()` from schema instead of inline checks
- Files changed: `src/schema.ts` (new), `src/errors.ts` (new), `src/validate.ts`, `src/commands/new.ts`, `src/commands/update.ts`
- **Learnings:**
  - Circular dependency between schema.ts and validate.ts resolved by extracting ValidationError to errors.ts
  - Re-export pattern maintains backward compatibility: `export { ValidationError } from './errors.ts'`
  - `as const satisfies` provides type inference while allowing the schema to be used at runtime

---

## 2026-01-08 - e5bfc0

- Created `src/test-helpers.ts` with shared test setup/teardown
- Refactored all 10 test files that had CLI test boilerplate to use the helper
- Files changed: `src/test-helpers.ts` (new), all `*.test.ts` files in commands/, `src/store.test.ts`, `src/help.test.ts`
- **Learnings:**
  - Test files that don't use CLI (id.test.ts, validate.test.ts) don't need the helper
  - Different setup patterns: `{ init: true }` for most tests, `{ init: false }` for init.test.ts, `{ createIssuesDir: true }` for store.test.ts
  - `setupTestDir` registers beforeEach/afterEach at module load time - must be called at top level, not inside test()

---

## 2026-01-08 - d4aebf

- Extracted `parseJsonOrExit` helper in validate.ts for JSON parse + error handling
- Refactored new.ts and update.ts to use the shared helper
- Files changed: `src/validate.ts`, `src/commands/new.ts`, `src/commands/update.ts`, `prd.json`
- **Learnings:**
  - Generic helper `parseJsonOrExit<T>(json, parseFn)` handles both SyntaxError and ValidationError uniformly
  - Place JSON parsing helpers in validate.ts alongside ValidationError since they're tightly coupled

---

## 2026-01-08 - c39dae

- Extracted command routing into `src/commands.ts` registry
- Commands now defined once with usage, description, and handler
- index.ts reduced from 110 lines to 26 lines
- help.ts now imports from commands.ts instead of duplicating definitions
- Files changed: `src/commands.ts` (new), `src/index.ts`, `src/help.ts`, `prd.json`
- **Learnings:**
  - Use `arg(args, index, usage)` helper for type-safe argument extraction with exit on missing
  - Complex flag handling (like `list`) can still live in handler, just part of registry
  - TypeScript doesn't narrow array indexing by length checks; use explicit undefined check

---

## 2026-01-08 - b28c9d

- Changed `chief list` to hide completed issues by default
- Added `--all` flag to show all issues (previous default behavior)
- Files changed: `src/commands/list.ts`, `src/index.ts`, `src/help.ts`, `src/commands/list.test.ts`, `prd.json`
- **Learnings:**
  - When changing default behavior, update existing tests that relied on old defaults
  - Flag priority: explicit flags override defaults, `--all` overrides `--open`

---

## 2026-01-08 - a17b8c

- Enabled clearing/changing parent with `chief update <id> '{"parent":...}'`
- Added validation to prevent issues with children from becoming children (would create >1 level nesting)
- Files changed: `src/validate.ts`, `src/validate.test.ts`, `src/commands/update.test.ts`, `prd.json`
- **Learnings:**
  - Parent field already supported in update, but nesting validation was incomplete
  - Must check both directions: parent cannot be child AND issue cannot have children

---

## 2026-01-08 - ff6a7b

- Added warning for unknown fields in `chief update` command
- Files changed: `src/commands/update.ts`, `src/commands/update.test.ts`, `prd.json`
- **Learnings:**
  - Print warnings to stderr so they don't interfere with stdout parsing
  - Warning pattern: detect invalid input, emit warning, continue with valid parts

---

## 2026-01-08 - ee5f6a

- Fixed multiline note formatting in `chief show` to maintain consistent indentation
- Files changed: `src/commands/show.ts`, `src/commands/show.test.ts`, `prd.json`
- **Learnings:**
  - For multiline list items: split by newlines, prefix first line with `  - `, subsequent lines with `    ` (4 spaces to align with content after bullet)

---

## 2026-01-08 - cc3d4e

- Added --label flag to `chief list` for filtering issues by label
- Files changed: `src/commands/list.ts`, `src/commands/list.test.ts`, `src/index.ts`, `src/help.ts`, `prd.json`
- **Learnings:**
  - Use `ListOptions` interface instead of multiple parameters for cleaner function signatures as options grow
  - When filtering parent/child hierarchy, show parent even if it doesn't match if any child matches (for context)
  - Combine status and label filtering with separate match functions for clarity

---

## 2026-01-07 - bb2c3d

- Added --open and --done flags to `chief list` for filtering by completion status
- Files changed: `src/commands/list.ts`, `src/commands/list.test.ts`, `src/index.ts`, `src/help.ts`, `prd.json`
- **Learnings:**
  - Export filter type (`ListFilter`) from command module for type safety when passing from index.ts
  - When filtering parent/child hierarchy, show children only if parent matches filter (children follow parent's visibility)
  - Print "No issues" when filter yields empty results, not just when store is empty

---

## 2026-01-07 - aa1b2c

- Implemented ID prefix matching for all commands that take an issue ID
- Files changed: `src/store.ts`, `src/commands/done.ts`, `src/commands/reopen.ts`, `src/commands/remove.ts`, `src/commands/show.ts`, `src/commands/note.ts`, `src/commands/update.ts`, `src/store.test.ts`, `src/commands/show.test.ts`
- **Learnings:**
  - Use `filter` + `startsWith` for prefix matching, check length for exact/ambiguous handling
  - Update commands to use resolved `issue.id` instead of input parameter after prefix resolution
  - The `update.ts` command was not using `findIssueOrExit` - refactored to use it for consistency

---

## 2026-01-07 - dd4e5f

- Made done/reopen commands idempotent with clear messaging
- Files changed: `src/commands/done.ts`, `src/commands/reopen.ts`, `src/commands/done.test.ts`, `src/commands/reopen.test.ts`
- **Learnings:**
  - Early return pattern with descriptive message avoids unnecessary writes
  - Tests should verify file is unchanged (compare timestamps/values) for no-op operations

---

## 2026-01-07 - k9l0m1

- Created install.sh for one-liner install via `curl | bash`
- Files changed: `install.sh` (new), `prd.json`
- **Learnings:**
  - OS detection: `uname -s` returns Darwin/Linux/MINGW*, `uname -m` returns x86_64/arm64
  - Use `${HOME}/.local/bin` as default install dir (XDG-ish, avoids sudo)
  - Check PATH with grep and suggest export line if not present

---

## 2026-01-07 - v1w2x3

- Extracted `findIssueOrExit` helper to DRY up duplicated issue lookup pattern
- Files changed: `src/store.ts`, `src/commands/done.ts`, `src/commands/reopen.ts`, `src/commands/remove.ts`, `src/commands/show.ts`, `src/commands/note.ts`
- **Learnings:**
  - Place shared helpers in the module that already exports the types they work with (store.ts has Issue/IssuesStore)
  - The helper returns `Issue` (not `Issue | undefined`) because it exits on failure - enables direct use without null checks

---

## 2026-01-07 - s8t9u0

- Refactored ANSI color/style handling to use `Bun.color()` for colors
- Created `src/color.ts` with centralized exports: RESET, DIM, BOLD, GREEN
- Updated `src/commands/list.ts` and `src/commands/show.ts` to import from color.ts
- Files changed: `src/color.ts` (new), `src/commands/list.ts`, `src/commands/show.ts`, `prd.json`
- **Learnings:**
  - `Bun.color()` only handles colors, not text styles (bold/dim/reset)
  - `Bun.color('green', 'ansi')` returns 256-color code `\x1b[38;5;28m` vs basic `\x1b[32m`
  - Both render visually identical in modern terminals

---

## 2026-01-07 - y4z5a6

- Verified help text cleanup task was already completed as part of j7k8l9
- All acceptance criteria met: no non-existent commands, update command present, all commands work
- Files changed: `prd.json` (mark done)
- **Learnings:**
  - Tasks can be implicitly completed as part of other work - verify before implementing
  - The j7k8l9 progress entry documented this: "Removed non-existent commands from help"

---

## 2026-01-07 - p5q6r7

- Implemented `doneAt` timestamp field for tracking when issues are completed
- Files changed: `src/store.ts`, `src/commands/done.ts`, `src/commands/reopen.ts`, `src/commands/show.ts`, `src/commands/new.ts`, `src/validate.ts`, tests
- **Learnings:**
  - Adding a new field requires updates to: type definition, validation, defaults in new command, and all test fixtures
  - Backward compatibility works because existing issues without the field get it added on first mutation

---

## 2026-01-07 - f1a0b2

- Completed parent story "Project scaffolding and core utilities"
- All child tasks done: c3d4e5, a7b8c9, d1e2f3, e4f5a6
- Verified acceptance criteria: end-to-end workflow, error handling, help text
- **Learnings:**
  - Parent stories auto-complete when all children are done
  - Verify acceptance criteria manually before marking parent complete

---

## 2026-01-07 - m2n3o4

- Implemented `chief update` command in `src/commands/update.ts`
- Files changed: `src/commands/update.ts`, `src/commands/update.test.ts`, `src/index.ts`, `src/help.ts`, `prd.json`
- **Learnings:**
  - Merge updates by iterating over a whitelist of updateable fields to prevent ID mutation
  - Reuse existing validation functions (validateIssueFields, validateParentRef) for update validation

---

## 2026-01-07 - j7k8l9

- Implemented CLI help and error handling in `src/help.ts` and `src/index.ts`
- Files changed: `src/help.ts`, `src/help.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Centralize help definitions in a separate module with structured data
  - Check for --help flag before switch statement to avoid code duplication in each case
  - Removed non-existent commands from help (criteria, label, edit, status were listed but not implemented)

---

## 2026-01-07 - c7d8e9

- Implemented `chief note` command with text argument in `src/commands/note.ts`
- Files changed: `src/commands/note.ts`, `src/commands/note.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Mutation commands that append to arrays: find by ID -> push to array -> write
  - Date formatting in YYYY-MM-DD: extract year/month/day, pad month/day with leading zeros

---

## 2026-01-07 - h3i4j5

- Implemented `chief show` command in `src/commands/show.ts`
- Files changed: `src/commands/show.ts`, `src/commands/show.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Read-only detail commands: find by ID -> format all fields -> print sections conditionally
  - Use ANSI `\x1b[1m` for bold headers to make output scannable

---

## 2026-01-07 - e1f2a3

- Implemented `chief remove` command in `src/commands/remove.ts`
- Files changed: `src/commands/remove.ts`, `src/commands/remove.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Collect IDs to remove using Set for efficient deletion
  - Use filter with Set.has for bulk removal from array

---

## 2026-01-07 - b8c9d0

- Implemented `chief reopen` command in `src/commands/reopen.ts`
- Files changed: `src/commands/reopen.ts`, `src/commands/reopen.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Inverse operations (done/reopen) can share the same pattern with minimal differences
  - Reopen is idempotent just like done - reopening an open issue succeeds silently

---

## 2026-01-07 - d5e6f7

- Implemented `chief done` command in `src/commands/done.ts`
- Files changed: `src/commands/done.ts`, `src/commands/done.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Simple mutation commands: find by ID -> mutate -> write
  - Idempotent operations (done on already-done) should succeed silently

---

## 2026-01-07 - g1h2i3

- Implemented `chief list` command in `src/commands/list.ts`
- Files changed: `src/commands/list.ts`, `src/commands/list.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Group children by parent using `Map<string, Issue[]>` for efficient lookup
  - Read-only commands follow simpler pattern: read store -> format output -> print

---

## 2026-01-07 - c9d0e1

- Implemented `chief new` command with JSON argument in `src/commands/new.ts`
- Files changed: `src/commands/new.ts`, `src/commands/new.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Separate input parsing/validation from applying defaults for cleaner code
  - Commands that modify state should: parse input -> read store -> generate ID -> apply defaults -> validate -> write

---

## 2026-01-07 - b2c3d4

- Implemented `chief init` command in `src/commands/init.ts`
- Files changed: `src/commands/init.ts`, `src/commands/init.test.ts`, `src/index.ts`, `prd.json`
- **Learnings:**
  - Integration tests running CLI from different cwd need absolute paths to the CLI entry point
  - Use `mkdir` with `recursive: true` to create parent directories idempotently
  - Commands should be organized in `src/commands/` directory and imported into index.ts

---

## 2026-01-07 - e4f5a6

- Implemented validation logic in `src/validate.ts`
- Files changed: `src/validate.ts`, `src/validate.test.ts`, `prd.json`
- **Learnings:**
  - Validation functions should throw descriptive errors, not return booleans
  - Type guard pattern (`function f(x: unknown): x is Type`) provides runtime validation with type narrowing
  - Separate field validation from referential integrity checks for cleaner testing

---

## 2026-01-07 - d1e2f3

- Implemented ID generation utility in `src/id.ts`
- Files changed: `src/id.ts`, `src/id.test.ts`
- **Learnings:**
  - `crypto.getRandomValues()` is globally available in Bun (no import needed)
  - Use Set for O(1) collision checking when generating unique IDs

---

## 2026-01-07 - a7b8c9

- Implemented core JSON read/write utilities in `src/store.ts`
- Files changed: `src/store.ts`, `src/store.test.ts`, `AGENTS.md`, `.gitignore`
- **Learnings:**
  - `Bun.file().size` returns 0 for non-existent files (doesn't throw), use `.exists()` instead
  - `Bun.file().exists()` is async, requires refactoring sync functions
  - `Bun.$` shell template provides clean syntax for filesystem ops in tests

---
